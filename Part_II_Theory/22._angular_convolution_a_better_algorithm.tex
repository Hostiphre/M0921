
\chapter{Angular Convolution, A Better Algorithm\label{chpt:angular-convolution}}

In section \ref{chpt:fft-spatial}, the spatial convolution is treated
by \acs{FFT} thanks to the transitional invariance that leads to
$\mathbf{r}_{12}=\mathbf{r}_{1}-\mathbf{r}_{2}$. However, as the
angular grid is not homogeneous, the relative coordinates of two angles
cannot be simply represented $\mathbf{\Omega}_{12}=\mathbf{\Omega}_{1}-\mathbf{\Omega}_{2}$,
therefore we cannot take advantage of the convolution property shown
in eq. (\ref{eq:convolution-1}-\ref{eq:convolution-2}). On the other
hand, these two-particle quantities have rotational invariance. As
proposed by Blum \citep{Blum_I,Blum_II} and used by Fries and Patey
\citep{Fries_Patey_1985}, a rotational invariant expansion technique
reduces the molecular Ornstein-Zernike (\acs{MOZ}) equation into
smaller irreducible matrix equations ($\mathsection$\textcolor{red}{...}).
As there is a mathematical equivalence between \acs{IET} and \acs{MDFT}
($\mathsection$\textcolor{red}{...}), where eq. (\ref{eq:gamma-k})
can be regarded as the \acs{MOZ} equation, this formalism can also
be applied to \acs{MDFT}.

\section{Angular convolution using Blum's reduction}

\marginpar{Here the projections $F_{\mu\nu,\chi}^{mn}$ are defined as in \citep{Fries_Patey_1985}.\textcolor{red}{{}
}Eq. (\ref{eq:Blum-reduced-OZ}) is mathematically identical with
\citep{Blum_I,Blum_II} but using $R_{\mu'\mu}^{m}=D_{\mu\mu'}^{m*}$.
The difference between the conventions of \acs{GSH} are listed in
$\mathsection$\ref{sec:Convention-of-GSH}.}To build a relation between the irreducible form of the \acs{MOZ}
equation deduced by Blum (in the definition of Fries \& Patey, detailed
in $\mathsection$\textcolor{red}{...}, with the symmetry $\hat{c'}_{\nu\mu,\chi}^{nm}(k)=\hat{c'}_{\mu\nu,\underline{\chi}}^{mn*}(k)$)
\begin{equation}
\hat{\gamma'}_{\lambda\mu,\underline{\chi}}^{lm}(k)=\sum_{n=0}^{n_{\mathrm{max}}}\sum_{\nu=-n}^{n}\left(-\right){}^{\chi+\nu}\Delta\hat{\rho'}_{\lambda\underline{\nu},\underline{\chi}}^{ln}(k)\hat{c'}_{\mu\nu,\chi}^{mn*}(k)\label{eq:Blum-reduced-OZ}
\end{equation}
and the \acs{MDFT}, a generalized spherical harmonic transform (\acs{GSHT})
treatment is proposed by Luc Belloni, developing the functional gradient
$\hat{\gamma}$ and the density $\hat{\rho}$ in eq. (\ref{eq:gamma-k})
on Wigner generalized spherical harmonics (\acs{GSH}):
\begin{equation}
\hat{\gamma}(\mathbf{k},\mathbf{\Omega}_{1})=\sum_{m\mu'\mu}f_{m}\hat{\gamma}_{\mu'\mu}^{m}(\mathbf{k})R_{\mu'\mu}^{m}(\mathbf{\Omega}_{1})\label{eq:gamma-projection}
\end{equation}
\begin{equation}
\Delta\hat{\rho}(\mathbf{k},\mathbf{\Omega}_{2})=\sum_{n\nu'\nu}f_{n}\Delta\hat{\rho}_{\nu',\nu}^{n}(\mathbf{k})R_{\nu',\nu}^{n}(\mathbf{\Omega}_{2})\label{eq:delta-rho-projection}
\end{equation}
where $0\leq m,n\leq n_{\mathrm{max}}$, $\left|\mu'\right|,\left|\mu\right|<m$
and $\left|\nu'\right|,\left|\nu\right|<n$. $f_{m}=\left(2m+1\right)^{\frac{1}{2}}=\left\Vert R_{\mu'\mu}^{m}\right\Vert ^{-1}$
is the normalization factor (according to Luc's definition).

The \acs{DCF} can also be expanded on rotational invariants \citep{Fries_Patey_1985}:
\begin{equation}
\hat{c}(k,\mathbf{\Omega}_{1},\mathbf{\Omega}_{2})=\sum_{mnl\mu\nu}f_{m}f_{n}\hat{c}_{\mu\nu}^{mnl}(k)\sum_{\mu'\nu'\lambda'}\left(\begin{array}{ccc}
m & n & l\\
\mu' & \nu' & \lambda'
\end{array}\right)R_{\mu'\mu}^{m}(\mathbf{\Omega}_{1})R_{\nu'\nu}^{n}(\mathbf{\Omega}_{2})R_{\lambda'0}^{l}(\hat{\mathbf{k}})\label{eq:c-projection}
\end{equation}

As \acs{GSH} possess orthogonality eq. (\ref{eq:gsh-orthogonality})
and symmetry eq. (\ref{eq:symm-gsh-1}), eq. (\ref{eq:gamma-k}) can
be rewritten by (\ref{eq:gamma-projection}, \ref{eq:delta-rho-projection},
\ref{eq:c-projection}), which gives:
\begin{equation}
\hat{\gamma}_{\mu'\mu}^{m}(\mathbf{k})=\sum_{nl\nu}\hat{c}_{\mu\nu}^{mnl}(k)\sum_{\nu'\lambda'}\left(-\right){}^{\nu'+\nu}\Delta\hat{\rho}_{\underline{\nu'}\underline{\nu}}^{n}(\mathbf{k})\left(\begin{array}{ccc}
m & n & l\\
\mu' & \nu' & \lambda'
\end{array}\right)R_{\lambda'0}^{l}(\hat{\mathbf{k}})\label{eq:im}
\end{equation}
thus the \acs{OZ} equation is expanded on \acs{GSH}s and rotational
invariants.

Note that eq. (\ref{eq:im}) is reducible. Blum's $\chi$-transform
\citep{Blum_II} defines: \marginpar{In fact, $\hat{c'}_{\mu\nu,\chi}^{mn}(k)$ is the conjugate of the
invariant in eq. (\ref{eq:Blum-reduced-OZ}).} 
\begin{equation}
\hat{c'}_{\mu\nu,\chi}^{mn}(k)=\sum_{l=\left|m-n\right|}^{m+n}\left(\begin{array}{ccc}
m & n & l\\
\chi & -\chi & 0
\end{array}\right)\hat{c}_{\mu\nu}^{mnl}(k)
\end{equation}
\begin{equation}
\hat{c}_{\mu\nu}^{mnl}(k)=\left(2l+1\right)\sum_{\chi=-\min(m,n)}^{\min(m,n)}\left(\begin{array}{ccc}
m & n & l\\
\chi & -\chi & 0
\end{array}\right)\hat{c'}_{\mu\nu,\chi}^{mn}(k)\label{eq:c-p}
\end{equation}

Invariants of form $F_{\mu\nu,\chi}^{mn}(k)$ have a very simple relation
with their combined function $F(k,\boldsymbol{\omega_{1}},\boldsymbol{\omega_{2}})$
in the intermolecular coordinate system (eq. (\ref{eq:local-forward},
\ref{eq:local_backward})). In \acs{MDFT} formalism, the projections
of $\hat{\gamma}$ and $\hat{\rho}$ in the local frame ($\boldsymbol{\omega}_{i}=\hat{\mathbf{k}}\mathbf{\Omega}_{i}$)
are
\begin{equation}
\hat{\gamma'}(\mathbf{k},\boldsymbol{\omega}_{1})=\sum_{m\chi\mu}f_{m}\hat{\gamma'}_{\chi\mu}^{m}(\mathbf{k})R_{\chi\mu}^{m}(\boldsymbol{\omega}_{1})\label{eq:gamma-projection-local}
\end{equation}
\begin{equation}
\Delta\hat{\rho'}(\mathbf{k},\boldsymbol{\omega}_{2})=\sum_{n\chi\nu}f_{n}\Delta\hat{\rho'}_{\chi\nu}^{n}(\mathbf{k})R_{\chi\nu}^{n}(\mathbf{\boldsymbol{\omega}}_{2})\label{eq:delta-rho-projection-local}
\end{equation}
and with the rotation formula of \acs{GSH} (eq. (\ref{eq:gsh-rotation})),
we have 
\begin{equation}
\hat{\gamma'}_{\chi\mu}^{m}(\mathbf{k})=\sum_{\mu'}\hat{\gamma}_{\mu'\mu}^{m}(\mathbf{k})R_{\mu'\chi}^{m}(\hat{\mathbf{k}})\label{eq:gamma-p}
\end{equation}
\begin{equation}
\Delta\hat{\rho}_{\underline{\nu'}\underline{\nu}}^{n}(\mathbf{k})=\sum_{\chi}\Delta\hat{\rho'}_{\chi\underline{\nu}}^{n}(\mathbf{k})R_{\underline{\nu'}\chi}^{n*}(\hat{\mathbf{k}})=\sum_{\chi}\Delta\hat{\rho'}_{\chi\underline{\nu}}^{n}(\mathbf{k})\left(-\right){}^{\chi+\nu'}R_{\nu'\underline{\chi}}^{n}(\hat{\mathbf{k}})\label{eq:rho-p}
\end{equation}

Using eq. (\ref{eq:gamma-p}), (\ref{eq:im}), eq. (\ref{eq:rho-p}),
eq. (\ref{eq:c-p}) and \acs{GSH} products relation eq. (\ref{eq:gg.a91})
and 3j-symbol orthogonality eq. (\ref{eq:3j-orthogonality}), we deduce
that:
\begin{equation}
\hat{\gamma'}_{\chi\mu}^{m}(\mathbf{k})=\sum_{n\nu}\left(-\right){}^{\chi+\nu}\hat{c'}_{\mu\nu,\chi}^{mn}(k)\Delta\hat{\rho'}_{\chi\underline{\nu}}^{n}(\mathbf{k})\label{eq:gamma-blum}
\end{equation}

If we take the conjugate of $\hat{c'}_{\mu\nu,\chi}^{mn*}(k)$, eq.
(\ref{eq:gamma-blum}) is mathematically identical to eq. (\ref{eq:Blum-reduced-OZ}),
as:
\begin{equation}
\hat{\gamma'}_{\chi\mu}^{m}(\mathbf{k})=\sum_{l\lambda}\hat{\gamma'}_{\lambda\mu,\underline{\chi}}^{lm}(k)R_{\underline{\chi}\lambda}^{l}(\boldsymbol{\omega})
\end{equation}
\begin{equation}
\hat{\rho'}_{\chi\underline{\nu}}^{n}(\mathbf{k})=\sum_{l\lambda}\Delta\hat{\rho'}_{\lambda\underline{\nu},\chi}^{ln}(k)R_{\chi\lambda}^{l*}(\boldsymbol{\omega})
\end{equation}
according to the rotational invariant transform in eq. (\ref{eq:local_backward}).

And in this way, the integral of the angular part in eq. (\ref{eq:gamma-k})
can be reduced to a sum of a few terms. Table \ref{tab:FE-of-OZ}
shows some parameters linking to computing cost of different algorithms.
\marginpar{{*} Only if we do not need to calculate $\hat{c}(\mathbf{k},\mathbf{\Omega}_{1},\mathbf{\Omega}_{2})$.}It
shows that the expansion on \acs{GSH}s (eq. (\ref{eq:im})) does
not give any reduction of \acs{FE} compared to its 6D function form
(eq. (\ref{eq:gamma-k}))$^{*}$; but after the Blum's $\chi$-transform,
the \acs{OZ} function is largely reduced. As the spatial convolution
takes advantage of the transitional invariance $r_{12}$, the $\chi$-transform
in fact makes use of the rotational invariance.

\begin{table}[h]
\centering{}\hspace{-4em}%
\noindent\begin{minipage}[t]{1.1\columnwidth}%
\begin{center}
\begin{tabular*}{1\textwidth}{@{\extracolsep{\fill}}ccccccc}
\toprule 
{\footnotesize{}$m_{\mathrm{max}}$} & {\footnotesize{}0} & {\footnotesize{}1} & {\footnotesize{}2} & {\footnotesize{}3} & {\footnotesize{}4} & {\footnotesize{}5}\tabularnewline
\midrule
{\footnotesize{}$N_{\Theta}$} & {\footnotesize{}1} & {\footnotesize{}2} & {\footnotesize{}3} & {\footnotesize{}4} & {\footnotesize{}5} & {\footnotesize{}6}\tabularnewline
{\footnotesize{}$N_{\mathrm{ang}}$ (Gauss-Legendre)} & {\footnotesize{}1 (1)} & {\footnotesize{}18 (6)} & {\footnotesize{}75 (45)} & {\footnotesize{}196 (84)} & {\footnotesize{}405 (225)} & {\footnotesize{}726 (330)}\tabularnewline
{\footnotesize{}$N_{\mathrm{ang}}$ (Lebedev$\times\psi$)} & {\footnotesize{}1 (1)} & {\footnotesize{}18 (6)} & {\footnotesize{}70 (42)} & {\footnotesize{}182 (78)} & {\footnotesize{}342 (190)} & {\footnotesize{}550 (250)}\tabularnewline
{\footnotesize{}$N_{\mathrm{proj}}$ } & {\footnotesize{}1 (1)} & {\footnotesize{}10 (4)} & {\footnotesize{}35 (19)} & {\footnotesize{}84 (40)} & {\footnotesize{}165 (85)} & {\footnotesize{}286 (140)}\tabularnewline
{\footnotesize{}FE for eq. (\ref{eq:gamma-k})} & {\footnotesize{}1 (1)} & {\footnotesize{}324 (36)} & {\footnotesize{}5625 (2025)} & {\footnotesize{}38416 (7056)} & {\footnotesize{}164025 (50625)} & {\footnotesize{}527076 (108900)}\tabularnewline
{\footnotesize{}FE for eq. (\ref{eq:im})} & {\footnotesize{}1 (1)} & {\footnotesize{}262 (34)} & {\footnotesize{}4787 (1459)} & {\footnotesize{}36588 (8116)} & {\footnotesize{}175989 (47221)} & {\footnotesize{}633490 (150566)}\tabularnewline
{\footnotesize{}FE for eq. (\ref{eq:gamma-blum})} & {\footnotesize{}1 (1)} & {\footnotesize{}34 (6)} & {\footnotesize{}259 (75)} & {\footnotesize{}1092 (252)} & {\footnotesize{}3333 (877)} & {\footnotesize{}8294 (2002)}\tabularnewline
\bottomrule
\end{tabular*}\caption[Number of FE needed by OZ equation of different form]{Number of \acs{FE} needed by \acs{OZ} equation of different form
for arbitrary solvent (outside the parentheses) and solvent possessing
$\mathrm{C}_{2v}$ symmetry (inside the parentheses)\label{tab:FE-of-OZ}}
\par\end{center}%
\end{minipage}
\end{table}


\section{Fast generalized spherical harmonic transform (FGSHT)\label{sec:fgsht}}

In the angular convolution algorithm above, the \acs{OZ} equation
is reduced to a few function evaluations by taking advantage of the
orthogonality and symmetries of \acs{GSH}s. To use this algorithm
as an analogous to the treatment of the convolution with \acs{FFT}
for spatial grids, it \textit{a priori }should be fast. This is exactly
possible owing to the exponential components in the definition of
\acs{GSH}, and a detailed discussion will be given later.

The \acs{FGSHT} provides a forward-backward transform between a general
angular function $F(\mathbf{\Omega})\equiv F(\cos\Theta,\Phi,\Psi)$
and its projections $F_{\mu'\mu}^{m}$ ($\left|\mu'\right|,\left|\mu\right|\leq m$):
\begin{equation}
F_{\mu'\mu}^{m}=\frac{f_{m}}{8\pi^{2}}\int\mathrm{d}\mathbf{\Omega}F(\mathbf{\Omega})R_{\mu'\mu}^{m*}(\mathbf{\Omega})\begin{array}{c}
\mathrm{(forward)}\end{array}\label{eq:GSHT_forward}
\end{equation}
\begin{equation}
F(\mathbf{\Omega})=\sum_{m,\mu',\mu}f_{m}F_{\mu'\mu}^{m}R_{\mu'\mu}^{m}(\mathbf{\Omega})\begin{array}{c}
\mathrm{(backward)}\end{array}\label{eq:GSHT_backward}
\end{equation}
where $R_{\mu'\mu}^{m}(\mathbf{\Omega})$ is the Wigner generalized
spherical harmonics (Appendix \ref{chpt:symmetry}), which form a
complete orthogonal set, being defined as:
\begin{equation}
R_{\mu'\mu}^{m}(\mathbf{\Omega})=r_{\mu'\mu}^{m}(\Theta)e^{-i(\mu'\Phi+\mu\Psi)}
\end{equation}


\subsection{Equivalence of order in angular quadratures and projections}

Suppose that $F(\mathbf{\Omega})$ is a polynomial of both $\cos\Theta$,
$\cos\Phi$ and $\cos\Psi$ of order $n$, ($n+1$ polynomial terms).
To expand completely this function as shown in equation (\ref{eq:GSHT_backward}),
at least $m_{\mathrm{max}}=n$ is needed, where $m_{\mathrm{max}}$
is the highest order of projections $F_{\mu'\mu}^{m}$ in the expansion.
Then to evaluate exactly the integration in equation (\ref{eq:GSHT_forward}),
at least $n+1$ for $\cos\Theta$ (Gauss-Legendre grid), $2n+1$ for
$\Phi$ (equal-spaced grid), $2n+1$ for $\Psi$ (equal-spaced grid)
points of angular grid are needed (c. f. appendix \ref{chpt:equivalence-of-quadrature-projection-order}).
In the case of water which possesses a $\mathrm{C}_{2}$ symmetry
$F(\Psi+\pi)=F(\Psi)$, only projections of even $\mu$ are nonzero:
\begin{eqnarray}
F_{\mu} & = & \int\mathrm{d}\Psi F(\Psi)e^{i\mu\Psi}=\int\mathrm{d}(\Psi+\pi)F(\Psi+\pi)e^{i\mu(\Psi+\pi)}\nonumber \\
 & = & e^{i\mu\pi}\int\mathrm{d}\Psi F(\Psi)e^{i\mu\Psi}=e^{i\mu\pi}F_{\mu}
\end{eqnarray}

\begin{equation}
F_{\mu}=\begin{cases}
0 & \mu=2n+1,n\in\mathbb{Z}\\
F_{\mu} & \mu=2n,n\in\mathbb{Z}
\end{cases}
\end{equation}

Therefore the function
\begin{equation}
F(\Psi)=\sum_{\mu}F_{\mu}e^{-i\mu\Psi}
\end{equation}
can be rewritten as:
\begin{equation}
F(\Psi_{2}/2\equiv\Psi)=\sum_{\mu_{2}\equiv\mu/2}F_{2\mu_{2}}e^{-i\mu_{2}\Psi_{2}}
\end{equation}

As $\left|\mu_{2}\right|\leq n/2$, $F(\Psi_{2}/2\equiv\Psi)$ is
a polynomial of $\cos\Psi_{2}$ of order $\mathrm{floor}(n/2)\equiv\left\lfloor n/2\right\rfloor $,
in the forward transform
\begin{equation}
F_{2\mu_{2}\equiv\mu}=\intop\mathrm{d}\Psi F(\Psi)e^{i\mu\Psi}=\frac{1}{2}\intop\mathrm{d}\Psi_{2}F(\Psi_{2}/2\equiv\Psi)e^{i\mu_{2}\Psi_{2}}
\end{equation}
the total degree $\cos\Psi_{2}$ polynomial in the integrand is $2\left\lfloor n/2\right\rfloor $,
then $2\left\lfloor n/2\right\rfloor +1$ points of $\Psi_{2}$ (or
$\Psi$) are needed. 

For further implementation, we take these conclusions, but distinguish
the order of quadrature $m_{\mathrm{max}}$ and the order of projection
$n_{\mathrm{max}}$ for numerical reason.

\subsection{Integration of $\Phi$, $\Psi$ using FFT}

Here we write eq. (\ref{eq:GSHT_forward}, \ref{eq:GSHT_backward})
in an explicit way:
\begin{equation}
F_{\mu'\mu}^{m}=\frac{f_{m}}{8\pi^{2}}\sum_{i=0}^{m_{\mathrm{max}}}w_{i}\sum_{j=0}^{2m_{\mathrm{max}}}\sum_{k=0}^{2\left\lfloor m_{\mathrm{max}}/s\right\rfloor }F(\Theta_{i},\Phi_{j},\Psi_{k})R_{\mu'\mu}^{m*}(\Theta_{i},\Phi_{j},\Psi_{k})\label{eq:GSHT-fwd}
\end{equation}
\begin{equation}
F(\Theta_{i},\Phi_{j},\Psi_{k})=\sum_{m=0}^{n_{\mathrm{max}}}f_{m}\sum_{\mu'=-m}^{m}\sum_{\underset{\mod(\mu,s)=0}{\mu=-m}}^{m}F_{\mu'\mu}^{m}R_{\mu'\mu}^{m}(\Theta_{i},\Phi_{j},\Psi_{k})\label{eq:GSHT-bwd}
\end{equation}
where $w_{i}$ is the weight of Gauss-Legendre quadrature ($m_{\mathrm{max}}+1$
points of $\Theta_{i}$), normalized to the total angular integration;
and $s=1$ or 2 according to the symmetry $\mathrm{C}_{s}$ of solvent.

To integrate eq. (\ref{eq:GSHT-fwd}) in a direct way, $(m_{\mathrm{max}}+1)(2m_{\mathrm{max}}+1)(2\left\lfloor m_{\mathrm{max}}/s\right\rfloor +1)=N_{\Theta}N_{\Phi\Psi}=N$
\acs{FE} are needed for each $F_{\mu'\mu}^{m}$, an overall $O(N_{FE}^{2})$
process is needed and \textit{vice versa}. Therefore, a faster algorithm
proposed by Numerical Recipes \citep{Numerical_Recipes_3ed} suggests
reducing this cost to $O(N_{\Theta}^{2}N_{\Phi\Psi}\ln N_{\Phi\Psi}\simeq N^{4/3})$
by \acs{FFT}.

Following this idea, eq. (\ref{eq:GSHT-fwd}) can be rewritten as:
\begin{equation}
F_{\mu'\mu}^{m}=\frac{f_{m}}{8\pi^{2}}\sum_{i=0}^{m_{\mathrm{max}}}w_{i}r_{\mu'\mu}^{m}(\Theta_{i})F_{\mu'\mu}(\Theta_{i})
\end{equation}
where $F_{\mu'\mu}(\Theta_{i})$ is the $\Phi$, $\Psi$ integration
evaluated using trapezoid (or Gauss-Chebyshef) quadrature:
\begin{eqnarray}
F_{\mu'\mu}(\Theta_{i}) & = & \sum_{j=0}^{2m_{\mathrm{max}}}\sum_{k=0}^{2\left\lfloor m_{\mathrm{max}}/s\right\rfloor }F(\Theta_{i},\Phi_{j},\Psi_{k})e^{i(\mu'\Phi_{j}+\mu\Psi_{k})}\label{eq:f_mup_mu}\\
 & = & \sum_{j=0}^{2m_{\mathrm{max}}}\sum_{k=0}^{2\left\lfloor m_{\mathrm{max}}/s\right\rfloor }F(\Theta_{i},\Phi_{j},\Psi_{k})e^{2\pi i\mu'j/(2m_{\mathrm{max}}+1)}e^{2\pi i\mu k/(2\left\lfloor m_{\mathrm{max}}/s\right\rfloor +1)}\nonumber 
\end{eqnarray}
that shares the same formula with an \acs{FFT}-2D process of $\left(2m_{\mathrm{max}}+1\right)\left(2\left\lfloor m_{\mathrm{max}}/s\right\rfloor +1\right)$
elements.

Similarly, the backward process (\ref{eq:GSHT_backward}) can be rewritten
as:
\begin{eqnarray}
F(\Theta_{i},\Phi_{j},\Psi_{k}) & = & \sum_{m=0}^{n_{\mathrm{max}}}f_{m}\sum_{\mu'=-m}^{m}\sum_{\underset{\mod(\mu,s)=0}{\mu=-m}}^{m}F_{\mu'\mu}^{m}R_{\mu'\mu}^{m}(\Theta_{i},\Phi_{j},\Psi_{k})\label{eq:f_mup_mu_2}\\
 & = & \sum_{\mu'=-n_{\mathrm{max}}}^{n_{\mathrm{max}}}\sum_{\underset{\mod(\mu,s)=0}{\mu=-n_{\mathrm{max}}}}^{n_{\mathrm{max}}}\sum_{m=\mathrm{max}\left(\left|\mu'\right|,\left|\mu\right|\right)}^{n_{\mathrm{max}}}f_{m}F_{\mu'\mu}^{m}R_{\mu'\mu}^{m}(\Theta_{i},\Phi_{j},\Psi_{k})\nonumber \\
 & = & \sum_{\mu'=-n_{\mathrm{max}}}^{n_{\mathrm{max}}}\sum_{\underset{\mod(\mu,s)=0}{\mu=-n_{\mathrm{max}}}}^{n_{\mathrm{max}}}F_{\mu'\mu}(\Theta_{i})e^{2\pi i\mu'j/(2m_{\mathrm{max}}+1)}e^{2\pi i\mu k/(2\left\lfloor m_{\mathrm{max}}/s\right\rfloor +1)}\nonumber 
\end{eqnarray}
with
\begin{equation}
F_{\mu'\mu}(\Theta_{i})=\sum_{m=\mathrm{max}\left(\left|\mu'\right|,\left|\mu\right|\right)}^{n_{\mathrm{max}}}f_{m}F_{\mu'\mu}^{m}r_{\mu'\mu}^{m}(\Theta_{i})\label{eq:f_mup_mu_3}
\end{equation}

\marginpar{Note that the \acs{GSHT} is able to treat the case $n_{\max}>m_{\max}$.}When
$n_{\max}\leq m_{\max}$, the double sum in eq. (\ref{eq:f_mup_mu_2})
is included in the \acs{FFT}-2D process of $\left(2m_{\mathrm{max}}+1\right)\left(2\left\lfloor m_{\mathrm{max}}/s\right\rfloor +1\right)$
elements. However, if $n_{\max}>m_{\max}$, the \acs{FFT}-2D process
only gives a partial sum of $\left|\mu'\right|,\left|\mu\right|\leq m_{\max}$,
the other terms in eq. (\ref{eq:f_mup_mu_2}) can only calculated
by a \acs{GSHT} process as $F_{\mu'\mu}(\Theta_{i})$ is not periodic
for $\mu'$ and $\mu$. There can be further approximations to treat
this problem, but for practical usage, we only consider the case of
$n_{\max}\leq m_{\max}$.

The FFTW3 library \citep{FFTW3} is used for implementation, which
performs discrete Fourier Transform (\acs{DFT}) as defined below:
\begin{equation}
Y_{k}=\sum_{j=0}^{n-1}X_{j}e^{-2\pi ijk/n}\begin{array}{c}
\mathrm{(forward)}\end{array}\label{eq:fftw3-fwd}
\end{equation}
\begin{equation}
X_{j}=\sum_{k=0}^{n-1}Y_{k}e^{2\pi ijk/n}\begin{array}{c}
\mathrm{(backward)}\end{array}\label{eq:fftw3-bwd}
\end{equation}

Note that after a forward-backward Fourier transform, the original
function is multiplied by a normalization factor $N_{k}$, which is
the total number of nodes $k$.

For input function $Y_{k}$ $(k=0,\ldots,n-1)$ in real number, FFTW3
only outputs elements $k=0,\ldots,\left\lfloor n/2\right\rfloor $
( $\left\lfloor n/2\right\rfloor +1$ complex numbers of $X_{j}$
are stocked), with the “Hermitian” symmetry
\begin{equation}
Y_{k}=Y_{n-k}^{*}\label{eq:yk_conjg}
\end{equation}
used to regenerate elements of $k>\left\lfloor n/2\right\rfloor $.
The resulting $X_{j}$ issue from the corresponding backward transform
is purely real. As the angular function $F(\mathbf{\Omega})$ is real,
and the \acs{GSH}s possess symmetry of eq. (\ref{eq:symm-gsh-1}):
\begin{equation}
R_{-\mu',-\mu}^{m}(\mathbf{\Omega})=\left(-1\right)^{\mu'+\mu}R_{\mu'\mu}^{m*}(\mathbf{\Omega})
\end{equation}
the symmetry relation between the projections are
\begin{equation}
F_{-\mu',-\mu}^{m}=\left(-1\right)^{\mu'+\mu}F_{\mu'\mu}^{m*}\label{eq:symm_f_m_mup_mu}
\end{equation}

Therefore only the projections of $\mu\geq0$ need to be stocked,
which can be calculated with only these FFTW3 output elements. The
full process of FFTW3-2D real to real transform is illustrated in
figure \ref{fig:FFTW3-2D-indices}.

\begin{figure}[h]
\centering{}%
\noindent\begin{minipage}[t]{1\textwidth}%
\begin{center}
\includegraphics[width=1\textwidth]{_figure/fftw3_indices}
\par\end{center}
\begin{center}
\caption[Indices arrangement in a complete forward-backward FFT-2D process
of m'$\times$m elements]{Indices arrangement in a complete forward-backward FFT-2D process
of m'$\times$m elements. The DFT of dim 1 ($k$ to $\mu$) and dim
2 ($j$ to $\mu'$) are done sequentially and \emph{vice versa}. Array
index is the one used by Fortran array, real index is the one shown
in eq. (\ref{eq:fftw3-fwd}) and (\ref{eq:fftw3-bwd}), $k$ and $j$
indices shown in the left as well as $\mu$ and $\mu'$ in the right
are those in eq. (\ref{eq:f_mup_mu}) and (\ref{eq:f_mup_mu_2}).
Here $\mathrm{m}=m_{\mathrm{max}}$ and $\mathrm{m}'=\left\lfloor m_{\mathrm{max}}/s\right\rfloor $.
\label{fig:FFTW3-2D-indices}}
\par\end{center}%
\end{minipage}
\end{figure}

As the output array of FFTW3 is periodic,
\begin{equation}
e^{2\pi i\mu k/n}=e^{2\pi i(\mu-n)k/n}e^{2\pi ik}=e^{2\pi i(\mu-n)k/n}\label{eq:mu-periodicity}
\end{equation}
the indices $\mu=m_{\mathrm{max}}+1,\ldots,2m_{\mathrm{max}}$ actually
correspond to $\mu=-m_{\mathrm{max}},\ldots,-1$. Note that eq. (\ref{eq:f_mup_mu})
and (\ref{eq:f_mup_mu_2}) do not possess the periodicity of eq. (\ref{eq:mu-periodicity}),
only in the domain of definition of $\mu'$ and $\mu$ some intermediary
functions share the same formula with \acs{FFT}.

Moreover, from eq. (\ref{eq:f_mup_mu}), (\ref{eq:f_mup_mu_3}) and
(\ref{eq:symm_f_m_mup_mu}), we can verify that
\begin{equation}
F_{\mu'\mu}(\Theta)=F_{-\mu',-\mu}^{*}(\Theta)
\end{equation}
The latter is used in the code because according to the definition
in eq. (\ref{eq:fftw3-fwd}) and (\ref{eq:fftw3-bwd}), $F_{-\mu',-\mu}(\Theta)$
is calculated instead of $F_{\mu'\mu}(\Theta)$.

\section{Operational algorithm\label{sec:Operational-algorithm}}

As described above, the whole process of $\gamma$ and $\mathcal{F}_{\mathrm{exc}}$
functional evaluation proposed by this algorithm can be concluded
as 8 operations.

Firstly, the Fourier transform of the density is computed:\textcolor{red}{
\begin{equation}
\Delta\hat{\rho}_{\mu'\mu}^{m}(\mathbf{k})=\int\mathrm{d}\mathbf{r}\Delta\rho_{\mu'\mu}^{m}(\mathbf{r})e^{-i\mathbf{r}\cdot\mathbf{k}}\label{eq:fft3d-fwd}
\end{equation}
}

\textcolor{red}{Then the solvent density variable $\Delta\rho(\mathbf{r},\mathbf{\Omega})$
is expanded on generalized spherical harmonics
\begin{equation}
\Delta\rho_{\mu'\mu}^{m}(\mathbf{r})=\frac{f_{m}}{8\pi^{2}}\int\mathrm{d}\mathbf{\Omega}\Delta\rho(\mathbf{r},\mathbf{\Omega})R_{\mu'\mu}^{m*}(\mathbf{\Omega})\label{eq:fgsht-fwd}
\end{equation}
}

Afterwards the projections in k-frame are then rotated into the local
coordinate system along the unit vector $\mathbf{\hat{k}}$
\begin{equation}
\Delta\hat{\rho'}_{\chi\mu}^{m}(\mathbf{k})=\sum_{\mu'}\Delta\hat{\rho}_{\mu'\mu}^{m}(\mathbf{k})R_{\mu'\chi}^{m}(\mathbf{\hat{k}})
\end{equation}
where the evaluation of rotation matrix elements by recurrence is
detailed in appendix.

Next, computing the OZ equation with Blum's reduction:
\begin{equation}
\hat{\gamma'}_{\chi\mu}^{m}(\mathbf{k})=\sum_{n,\nu}(-1)^{\chi+\nu}\hat{c}_{\mu\nu,\chi}^{mn}(\mathbf{k})\Delta\hat{\rho'}_{\chi\underline{\nu}}^{n}(\mathbf{k})\label{eq:OZ-2}
\end{equation}

The $\gamma$ projections are then transformed back to global coordinates
system:
\begin{equation}
\hat{\gamma}_{\mu'\mu}^{m}(\mathbf{k})=\sum_{\chi}\hat{\gamma'}_{\chi\mu}^{m}(\mathbf{k})R_{\mu'\chi}^{m*}(\mathbf{\hat{k}})
\end{equation}

From here the inverse Fourier transform of these projections is:
\begin{equation}
\gamma_{\mu'\mu}^{m}(\mathbf{r})=\int\mathrm{d}\mathbf{k}\hat{\gamma}_{\mu'\mu}^{m}(\mathbf{k})e^{i\mathbf{r}\cdot\mathbf{k}}
\end{equation}

Then the function in angular frame can thus be rebuilt
\begin{equation}
\gamma(\mathbf{r},\mathbf{\Omega})=\sum_{m,\mu',\mu}f_{m}\gamma_{\mu'\mu}^{m}(\mathbf{r})R_{\mu'\mu}^{m}(\mathbf{\Omega})\label{eq:fgsht-bwd}
\end{equation}

Finally, the functional $\mathcal{F}_{\mathrm{exc}}$ is computed
by
\begin{equation}
\mathcal{F}_{\mathrm{exc}}=\frac{1}{2}\int\mathrm{d}\mathbf{r}\mathrm{d}\mathbf{\Omega}\Delta\rho(\mathbf{r},\mathbf{\Omega})\gamma(\mathbf{r},\mathbf{\Omega})
\end{equation}

As described above, the whole process of $\gamma$ and $\mathcal{F}_{\mathrm{exc}}$
functional evaluation can be concluded as 8 operations.

\subsection{Commutativity between operations\label{subsec:Commutativity-between-operations}}

As mentioned in the operational algorithm, three types of operations
are being done before and after the \acs{OZ} equation. They are
\begin{enumerate}
\item Fast Fourier Transform for 3-dimensional spatial grid (FFT3D): implemented
by package FFTW3 \citep{FFTW3}, mathematically leading to no accuracy
lost.
\item Fast generalized spherical harmonics transform (\acs{FGSHT}): has
real or complex input, is exact if $F(\mathbf{\Omega})$ is a polynomial
of $\cos\Theta$, $\cos\Phi$ and $\cos\Psi$ of order at most $m_{\mathrm{max}}$.
\item Rotation between laboratory coordinate system and local system linked
to vector $\mathbf{k}$ (RotS): can be done for both function and
projections. It introduces a minus error in accuracy at origin and
border of the box, which will be discussed in the next chapter.
\end{enumerate}
Their commutativity is shown in figure \ref{fig:Commutativity-of-operations}.

\begin{figure}[h]
\begin{centering}
\includegraphics{_figure/algorithms_commutativity}
\par\end{centering}
\caption[Commutativity of operations]{Commutativity of operations. (a) FFT3D and FGSHT; (b) RotS and FGSHT;
(c) FFT3D and RotS\label{fig:Commutativity-of-operations}}
\end{figure}


\subsubsection{FFT3D and FGSHT}

The FFT3D

\[
f(\mathbf{r})=\int\hat{f}(\mathbf{k})e^{i\mathbf{k}\cdot\mathbf{r}}
\]
\[
\hat{f}(\mathbf{k})=\int f(\mathbf{r})e^{-i\mathbf{k}\cdot\mathbf{r}}
\]
does not depend on the angular part of the function, and
\[
f(\mathbf{\Omega})=\sum_{m\mu'\mu}f_{m}f_{\mu'\mu}^{m}R_{\mu'\mu}^{m}(\mathbf{\Omega})
\]
\[
f_{\mu'\mu}^{m}=\int f_{m}f(\mathbf{\Omega})R_{\mu'\mu}^{m}(\mathbf{\Omega})
\]
does not depend on the spatial part of the function. The two operations
are commutative.

Firstly, the solvent density variable $\Delta\rho(\mathbf{r},\mathbf{\Omega})$
is expanded on generalized spherical harmonics
\begin{equation}
\Delta\rho_{\mu'\mu}^{m}(\mathbf{r})=\frac{f_{m}}{8\pi^{2}}\int\mathrm{d}\mathbf{\Omega}\Delta\rho(\mathbf{r},\mathbf{\Omega})R_{\mu'\mu}^{m*}(\mathbf{\Omega})\label{eq:fgsht-fwd-1}
\end{equation}

Then the Fourier transform of these projections is computed:
\begin{equation}
\Delta\hat{\rho}_{\mu'\mu}^{m}(\mathbf{k})=\int\mathrm{d}\mathbf{r}\Delta\rho_{\mu'\mu}^{m}(\mathbf{r})e^{-i\mathbf{r}\cdot\mathbf{k}}\label{eq:fft3d-fwd-1}
\end{equation}


\subsubsection{FGSHT and coordinate rotation}

Function $\hat{f'}$ intermolecular frame can be deduced from the
function $\hat{f}$ in laboratory frame 
\[
\hat{f}(\mathbf{k},\mathbf{\Omega})=\hat{f'}(\mathbf{k},\boldsymbol{\omega}_{k})
\]
where the two can both be expanded on \acs{GSH}

\[
\hat{f}(\mathbf{k},\mathbf{\Omega})=\sum_{m\mu'\mu}f_{m}\hat{f}_{\mu'\mu}^{m}(\mathbf{k})R_{\mu'\mu}^{m}(\mathbf{\Omega})
\]

\[
\hat{f'}(\mathbf{k},\boldsymbol{\omega}_{k})=\sum_{m\chi\mu}f_{m}\hat{f'}_{\chi\mu}^{m}(\mathbf{k})R_{\chi\mu}^{m}(\boldsymbol{\omega}_{k})
\]

And the relations between projections are simple

\[
f'_{\chi\mu}^{m}(\mathbf{k})=\sum_{\mu'}R_{\mu'\chi}^{m}(\hat{\mathbf{k}})f_{\mu'\mu}^{m}(\mathbf{k})
\]
\[
f_{\mu'\mu}^{m}(\mathbf{k})=\sum_{\chi}R_{\mu'\chi}^{m*}(\hat{\mathbf{k}})f'{}_{\chi\mu}^{m}(\mathbf{k})
\]
Thus the two operations are commutative.

\subsubsection{Coordinate rotation and FFT3D}

The rotation from $f(\mathbf{r},\mathbf{\Omega})$ to $f(\mathbf{r},\boldsymbol{\omega})$
depends on the vector $\mathbf{r}$, of which the information is totally
lost after FFT3D. The rotation from $f(\mathbf{k},\mathbf{\Omega})$
to $f(\mathbf{k},\boldsymbol{\omega})$ can only depend on the vector
$\mathbf{k}$, they are not the same rotation, therefore non-commutative. 

\subsection{aa}

\subsection{Reduction by symmetry\label{subsec:Reduction-by-symmetry}}

A further reduction of computing cost can be made by performing approximately
only half of the operations, thanks to the symmetric relations between
the projections.

In eq. (\ref{eq:fgsht-fwd}), $\Delta\rho(\mathbf{r},\mathbf{\Omega})$
is real. Thanks to the property of \acs{GSH} \textcolor{red}{(eq.
(appendix)),}
\[
R_{\mu'\mu}^{m}(\mathbf{\Omega})=(-)^{\mu'+\mu}R_{-\mu'-\mu}^{m*}(\mathbf{\Omega})
\]
we find
\begin{equation}
\Delta\hat{\rho}_{\mu'\mu}^{m}(\mathbf{r})=(-)^{\mu'+\mu}\Delta\hat{\rho}_{-\mu',-\mu}^{m*}(\mathbf{r})\label{eq:0}
\end{equation}
therefore only $\mu'>0$ or $\mu>0$ is needed to generate all information.

When $\Delta\hat{\rho}_{\mu'\mu}^{m}(\mathbf{r})$ is transformed
into $k$-space, replacing eq. (\ref{eq:fft3d-fwd}) with eq. (\ref{eq:0})
gives
\begin{equation}
\Delta\hat{\rho}_{\mu'\mu}^{m}(\mathbf{k})=(-)^{\mu'+\mu}\Delta\hat{\rho}_{-\mu'-\mu}^{m*}(-\mathbf{k})\label{eq:1}
\end{equation}
Thus only the projections of $\mu'>0$, $\mu>0$ or $\mathbf{k}$
where one of the dimensions $k_{i}>0$ are independent.

The rotation to local frame is governed by the relation \textcolor{red}{(prove?):}
\begin{equation}
R_{\mu'\chi}^{m}(\hat{\mathbf{k}})=(-)^{m}R_{\mu',-\chi}^{m}(-\hat{\mathbf{k}})=(-)^{m+\mu'+\chi}R_{-\mu',\chi}^{m}(-\hat{\mathbf{k}})\label{eq:3}
\end{equation}
which gives
\begin{equation}
\Delta\hat{\rho'}_{\chi\mu}^{m}(\mathbf{k})=(-)^{m+\mu+\chi}\Delta\hat{\rho'}_{\chi,-\mu}^{m*}(-\mathbf{k})\label{eq:2}
\end{equation}
Thanks to the symmetry\textcolor{red}{{} (eq. (appendix))} 
\begin{equation}
\hat{c'}_{\mu\nu,\chi}^{mn}(k)=(-)^{m+n+\mu+\nu}\hat{c'}_{\underline{\mu}\underline{\nu},\chi}^{mn*}(k)
\end{equation}
\begin{equation}
\hat{c'}_{\mu\nu,\chi}^{mn}(k)=(-)^{m+n}\hat{c'}_{\nu\mu,\chi}^{nm}(k)
\end{equation}
\begin{equation}
\hat{c'}_{\mu\nu,\underline{\chi}}^{mn}(k)=\hat{c'}_{\underline{\mu}\underline{\nu},\chi}^{mn}(k)=(-)^{m+n}\hat{c'}_{\mu\nu,\chi}^{mn*}(k)
\end{equation}
$\hat{\gamma'}_{\chi\mu}^{m}(\mathbf{k})$ possesses the same symmetry.
Thus the\acs{OZ} equation can be reduced by a factor of two.

\begin{figure}[h]
\begin{centering}
\includegraphics{_figure/test_lmn}
\par\end{centering}
\caption{Distribution of points to be calculated according to symmetry in a
2D plan}
\end{figure}

